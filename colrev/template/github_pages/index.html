<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Literature Dashboard</title>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/cr-1.5.6/datatables.min.css" />
</head>

<body>
    <div class="container p-3 mt-3 border">
        <button id="button-bib">Export selection as BibTeX</button>
        <button id="button-ris">Export selection as RIS (Zotero)</button>
        <div id="literature-table"></div>
    </div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/citation-js@0.6.1"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.12.1/datatables.min.js"></script>
    <script type="text/javascript">
        const Cite = require('citation-js');

        let literature;

        $.ajax({
            type: "GET",
            url: "./data.bib",
            success: function (data) {
                literature = new Cite(data);
                bibToTable(literature.data);
            }
        });

        function bibToTable(tableData) {
            let table_div = document.getElementById('literature-table');
            let html = '<table id="literature" class="table table-condensed table-hover table-striped">';
            if (tableData.length == 0 || typeof (tableData[0]) === 'undefined') {
                return null
            } else {
                const header = ["Author", "Title", "Year", "Journal/Booktitle", "Volume", "Number", "Pages"];
                html += '<thead>';
                html += '<tr>';
                header.forEach(function (colData) {
                    html += '<th>' + colData + '</th>';
                });
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                tableData.forEach(function (row) {
                    html += '<tr id="' + row['id'] + '">';
                    html += '<td>' + row['author'].map(author => author['family'] + ', ' + author['given']).join(" and ") + '</td>';
                    html += '<td>' + row['title'] + '</td>';
                    html += '<td>' + row['issued']['date-parts'][0][0] + '</td>';
                    html += '<td>' + (row['container-title'] === undefined ? '' : row['container-title']) + '</td>';
                    html += '<td>' + (row['volume'] === undefined ? '' : row['volume']) + '</td>';
                    html += '<td>' + (row['issue'] === undefined ? '' : row['issue']) + '</td>';
                    html += '<td>' + (row['page'] === undefined ? '' : row['page']) + '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                table_div.innerHTML = html;
                initDataTable();
            }
        }

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function filter(table) {
            let filterIds = []
            for (let i = 0; i < table.rows('.selected').data().length; i++) {
                filterIds.push(table.rows('.selected').data()[i]['DT_RowId'])
            }
            let litExport = new Cite();
            litExport.add(literature.data.filter(el => filterIds.includes(el.id)));
            return litExport;
        }

        function initDataTable() {
            var table = $('#literature').DataTable();

            $('#literature tbody').on('click', 'tr', function () {
                $(this).toggleClass('selected');
            });

            $('#button-bib').click(function () {
                let downloadData = filter(table);
                if (downloadData.data.length > 0) {
                    download('export.bib', downloadData.format('bibtex'));
                }
            });

            $('#button-ris').click(function () {
                let downloadData = filter(table);
                if (downloadData.data.length > 0) {
                    download('export.ris', downloadData.format('ris'));
                }
            });

            $('#button-enw').click(function () {
                let downloadData = filter(table);
                if (downloadData.data.length > 0) {
                    download('export.enw', downloadData.format('enw'));
                }
            });
        }
    </script>
</body>

</html>